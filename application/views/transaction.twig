{% extends "main-layout.twig" %}

{% block pagetitle %}مدیریت تراکنش‌ها
{% endblock %}

{% block content %}
<div class="p-6">
	<div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
		<h3 class="text-lg font-semibold text-gray-800">تراکنش‌های مالی شما</h3>

		<div class="flex flex-wrap gap-3 items-center w-full md:w-auto">
			<!-- Add Transaction Button -->
			<button id="addTransactionBtn"
				class="bg-indigo-600 text-white mx-6 py-2 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 flex items-center justify-center">
				<i class="fas fa-plus ml-1"></i>
				تراکنش جدید
			</button>

			<!-- Form (now horizontal) -->
			<form class="flex flex-wrap gap-2 items-center">
				<!-- Category Dropdown -->
				<select name="category_id" id="categoryFilter"
					class="border rounded-lg px-4 py-2 pr-8 focus:outline-none focus:ring-2 focus:ring-indigo-200">
					<option selected disabled>انتخاب کنید</option>
					{% for category in categories %}
					<option value="{{category.id}}">{{category.title}}</option>
					{% endfor %}
				</select>

				<!-- Type Dropdown -->
				<select name="type" id="typeFilter"
					class="border rounded-lg px-4 py-2 pr-8 focus:outline-none focus:ring-2 focus:ring-indigo-200">
					<option selected disabled>انتخاب کنید</option>
					<option value="income">درآمد</option>
					<option value="expense">هزینه</option>
				</select>

				<!-- Search Button -->
				<button
					class="bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 flex items-center justify-center">
					<i class="fa-solid fa-magnifying-glass"></i>
					جستجو
				</button>

				<!-- Reset Link -->
				<a href="{{base_url('/Transactions/index')}}"
					class="cursor-pointer bg-orange-600 text-white py-2 px-4 rounded-lg hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 flex items-center justify-center">
					<i class="fa-solid fa-arrows-rotate"></i>
					نمایش همه
				</a>
			</form>
		</div>
	</div>

	<!-- کارت‌های خلاصه آماری -->
	<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
		<div class="bg-white p-6 rounded-lg shadow-sm border-t-4 border-green-500">
			<div class="flex justify-between items-start">
				<div>
					<p class="text-gray-500">کل درآمدها</p>
					<p class="text-2xl font-bold mt-2">{{toPrc(income)}}
						تومان</p>
				</div>
				<div class="bg-green-100 p-3 rounded-full">
					<i class="fas fa-arrow-up text-green-500"></i>
				</div>
			</div>
		</div>

		<div class="bg-white p-6 rounded-lg shadow-sm border-t-4 border-red-500">
			<div class="flex justify-between items-start">
				<div>
					<p class="text-gray-500">کل هزینه‌ها</p>
					<p class="text-2xl font-bold mt-2">{{toPrc(expense)}}
						تومان</p>
				</div>
				<div class="bg-red-100 p-3 rounded-full">
					<i class="fas fa-arrow-down text-red-500"></i>
				</div>
			</div>
		</div>

		<div class="bg-white p-6 rounded-lg shadow-sm border-t-4 border-indigo-500">
			<div class="flex justify-between items-start">
				<div>
					<p class="text-gray-500">تعداد کل تراکنش ها</p>
					<p class="text-2xl font-bold mt-2">{{toNum(totalRecords)}}
						تراکنش</p>
				</div>
				<div class="bg-indigo-100 p-3 rounded-full">
					<i class="fas fa-exchange-alt text-indigo-500"></i>
				</div>
			</div>
		</div>
	</div>

	<!-- جدول تراکنش‌ها -->
	<div class="bg-white rounded-lg shadow-sm overflow-hidden">
		<div class="overflow-x-auto">
			<table class="min-w-full divide-y divide-gray-200">
				<thead class="bg-gray-50">
					<tr>
						<th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
							عنوان</th>
						<th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">مبلغ
						</th>
						<th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
							دسته‌بندی</th>
						<th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">نوع
						</th>
						<th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
							تاریخ</th>
						<th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
							عملیات</th>
					</tr>
				</thead>
				<tbody class="bg-white divide-y divide-gray-200">
					<!-- تراکنش   -->
					{% for transaction in transactions %}
					<tr data-transaction-id="{{transaction.id}}">
						<td class="px-6 py-4 whitespace-nowrap">
							<div class="text-sm font-medium text-gray-900">{{transaction.title}}</div>
						</td>
						<td class="px-6 py-4 whitespace-nowrap">
							<div class="text-sm text-red-600 font-medium">{{toPrc(transaction.amount)}}</div>
						</td>
						<td class="px-6 py-4 whitespace-nowrap">
							<div class="text-sm text-gray-900">{{transaction.category_title}}</div>
						</td>
						<td class="px-6 py-4 whitespace-nowrap">
							<span
								class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
								{{transaction.type == 'income' ? 'درآمد' : 'هزینه'}}
							</span>
						</td>
						<td class="px-6 py-4 whitespace-nowrap">
							<div class="text-sm text-gray-500">{{toNum(jdate(transaction.created_at))}}</div>
						</td>
						<td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
							<button class="edit-btn text-indigo-600 hover:text-indigo-900 mr-3"
								data-transaction="{{json(transaction)}}">
								<i class="fas fa-edit"></i>
							</button>
							<a href="#"
								data-delete-url="{{base_url('/Transactions/delete_transaction')}}/{{transaction.id}}"
								class="delete-transaction-btn text-red-600 hover:text-red-900">
								<i class="fas fa-trash"></i>
							</a>
						</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>

		<!-- صفحه‌بندی -->
		<div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
			<div class="flex-1 flex justify-between sm:hidden">
				<a href="#"
					class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
					قبلی
				</a>
				<a href="#"
					class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
					بعدی
				</a>
			</div>
			<div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
				<div>
					<p class="text-sm text-gray-700">
						نمایش
						<span class="font-medium">{{offset+1}}</span>
						تا
						<span class="font-medium">{{(offset)+currentRecords}}</span>
						از
						<span class="font-medium">{{totalRecords}}</span>
						نتیجه
					</p>
				</div>
				<div>
					<nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
						<button onclick="
								
								navigatePages(-1)"
							class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
							<span class="sr-only">قبلی</span>
							<i class="fas fa-chevron-right"></i>
						</button>
						{%for i in pages%}
						<button onclick="goToPage({{i}})" class="{{i==currentPage ? " z-10 bg-indigo-50
							border-indigo-500 text-indigo-600 relative inline-flex items-center px-4 py-2 border text-sm
							font-medium"
							: "bg-white border-gray-300 text-gray-500 hover:bg-gray-50 relative inline-flex items-center px-4 py-2 border text-sm font-medium"
							}}">
							{{toNum(i)}}
						</button>
						{% endfor %}
						<button onclick="
								
								navigatePages(1)"
							class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
							<span class="sr-only">بعدی</span>
							<i class="fas fa-chevron-left"></i>
						</button>
					</nav>
				</div>
			</div>
		</div>
	</div>

	<!-- مودال تراکنش -->
	<div id="transactionModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
		<div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
			<div class="flex justify-between items-center mb-4">
				<h3 class="text-lg font-medium" id="modalTitle">تراکنش جدید</h3>
				<button class="close-modal text-gray-400 hover:text-gray-500">
					<i class="fas fa-times"></i>
				</button>
			</div>

			<form id="transactionForm" method="POST">
				<input type="hidden" id="transactionId" name="transaction_id" value="">
				<div class="grid grid-cols-1 gap-4 mb-4">
					<div>
						<label for="transactionTitle" class="block text-sm font-medium text-gray-700 mb-1">عنوان
							تراکنش</label>
						<input type="text" id="transactionTitle" name="title"
							class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-200">
					</div>

					<div>
						<label for="transactionAmount" class="block text-sm font-medium text-gray-700 mb-1">مبلغ
							(تومان)</label>
						<input type="number" id="transactionAmount" name="amount"
							class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-200">
					</div>

					<div class="grid grid-cols-2 gap-4">
						<div>
							<label for="transactionType" class="block text-sm font-medium text-gray-700 mb-1">نوع
								تراکنش</label>
							<select id="transactionType" name="type"
								class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-200">
								<option value="income">درآمد</option>
								<option value="expense">هزینه</option>
							</select>
						</div>

						<div>
							<label for="transactionCategory"
								class="block text-sm font-medium text-gray-700 mb-1">دسته‌بندی</label>
							<select id="transactionCategory" name="category_id"
								class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-200">
								<option selected disabled value="">انتخاب کنید</option>
								{% for category in categories %}
								<option value="{{category.id}}">{{category.title}}</option>
								{% endfor %}
							</select>
						</div>
					</div>
				</div>

				<div class="flex justify-end space-x-3">
					<button type="button"
						class="close-modal mx-2 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
						انصراف
					</button>
					<button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
						<span id="submitBtnText">ثبت تراکنش</span>
					</button>
				</div>
			</form>
		</div>
	</div>
</div>

<!-- jQuery و اسکریپت‌های مربوطه -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
	$(document).ready(function () { // متغیر برای ذخیره حالت فعلی (ایجاد یا ویرایش)
		let currentAction = 'create';

		// باز کردن مودال برای ایجاد تراکنش جدید
		$('#addTransactionBtn').click(function () {
			currentAction = 'create';
			$('#modalTitle').text('تراکنش جدید');
			$('#submitBtnText').text('ثبت تراکنش');
			$('#transactionForm').attr('action', '{{ base_url(' / Transactions / insert_transaction') }}');
			$('#transactionId').val('');
			$('#transactionForm')[0].reset();
			$('#transactionModal').removeClass('hidden');
		});

		// باز کردن مودال برای ویرایش تراکنش
		$(document).on('click', '.edit-btn', function () {
			currentAction = 'edit';
			let data = $(this).data('transaction');
			$('#transactionId').val(data.id);
			$('#transactionTitle').val(data.title);
			$('#transactionAmount').val(data.amount);
			$('#transactionCategory').val(data.category_title);
			$('#transactionType').val(data.type === 'income' ? 'income' : 'expense');
			$('#transactionCategory').val(data.category_id);

			// تنظیمات فرم
			$('#modalTitle').text('ویرایش تراکنش');
			$('#submitBtnText').text('ذخیره تغییرات');
			$('#transactionForm').attr('action', '{{ base_url(' / Transactions / insert_transaction') }}');
			$('#transactionModal').removeClass('hidden');
		});

		// بستن مودال
		$(document).on('click', '.close-modal', function () {
			$('#transactionModal').addClass('hidden');
		});

		$('.delete-transaction-btn').on('click', function (e) {
			e.preventDefault(); // stop navigation

			let deleteUrl = $(this).data('delete-url');

			Swal.fire({
				title: "آیا مطمئنید؟",
				text: "آیا می خواهید تراکنش مورد نظر حذف شود؟",
				icon: "warning",
				showCancelButton: true,
				confirmButtonColor: "#3085d6",
				cancelButtonColor: "#d33",
				confirmButtonText: "بله، حذف کن!",
				cancelButtonText: "خیر"
			}).then((result) => {
				if (result.isConfirmed) {
					window.location.href = deleteUrl;
				}
			});
		});
	});
	function goToPage(page) {
		const url = new URL(window.location.href);
		url.searchParams.set('page', page);
		window.location.href = url.toString();
	}

	function navigatePages(navigate) {
		const url = new URL(window.location.href);
		let currentPage = url.searchParams.get('page') || 1;
		let siblingPage = parseInt(currentPage) + navigate;
		url.searchParams.set('page', siblingPage);
		if (siblingPage >= 1 && siblingPage <= {{ lastPage }
	}) {
		window.location.href = url.toString();
	}
}
</script>
{% endblock %}