{% extends "main-layout.twig" %}

{% block pagetitle %}پروفایل کاربری{% endblock %}

{% block content %}
<div id="user-info">
    <div class="p-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- بخش اطلاعات کاربر -->
            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-6">اطلاعات شخصی</h3>
                
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-700 mb-1">نام کامل</label>
                            <input 
                                type="text" 
                                id="name" 
                                name="name" 
                                v-model="userName" 
                                class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                            >
                        </div>
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">ایمیل</label>
                            <input 
                                type="text" 
                                id="email" 
                                name="email" 
                                v-model="email" 
                                class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                            >
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">تاریخ ایجاد حساب</label>
                            <div class="w-full border rounded-lg px-3 py-2 bg-gray-50" v-html="toPersianNumber(createdAt)">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">آخرین به‌روزرسانی</label>
                            <div class="w-full border rounded-lg px-3 py-2 bg-gray-50" v-html="toPersianNumber(updatedAt)">
                            </div>
                        </div>
                    </div>
                    
                    <div class="pt-4">
                        <button @click="updateUser()" class="bg-indigo-600 text-white py-2 px-6 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            ذخیره تغییرات
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- بخش تصویر پروفایل -->
            <div class="bg-white p-6 rounded-lg shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-6">تصویر پروفایل</h3>
                
                <form @submit.prevent="uploadImage" enctype="multipart/form-data">
                    <div class="flex flex-col items-center">
                        <div class="relative mb-4">
                            <img 
                                :src
                                alt="پروفایل کاربر" 
                                class="w-32 h-32 rounded-full object-cover border-4 border-indigo-100"
                            >
                        </div>
                        
                        <div class="w-full">
                            <input 
                                type="file" 
                                id="profile_image" 
                                name="profile_image"
                                accept="image/*"
                                class="hidden"
                                @change="onFileChange"
                            >
                            <label 
                                for="profile_image" 
                                class="block border border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:bg-gray-50"
                            >
                                <i class="fas fa-cloud-upload-alt text-gray-400 mb-1"></i>
                                <p class="text-sm text-gray-500">تصویر جدید را انتخاب کنید</p>
                            </label>
                            <p class="text-xs text-gray-500 mt-2">فرمت‌های مجاز: JPG, PNG حداکثر 2MB</p>
                        </div>
                        
                        <div class="mt-4 w-full">
                            <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                آپلود تصویر
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    </div>
    
    <!-- بخش تغییر رمز عبور -->
    <div id="change-password" class="mt-6 bg-white p-6 rounded-lg shadow-sm">
        <h3 class="text-lg font-semibold text-gray-800 mb-6">تغییر رمز عبور</h3>
        
        <div class="space-y-4 max-w-lg">
            <div>
                <label for="current_password" class="block text-sm font-medium text-gray-700 mb-1">رمز عبور فعلی</label>
                <div class="relative">
                    <input 
                        type="password" 
                        id="current_password" 
                        name="current_password"
                        v-model="currentPassword" 
                        class="w-full pr-10 pl-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-200"
                    >
                </div>
            </div>
            
            <div>
                <label for="new_password" class="block text-sm font-medium text-gray-700 mb-1">رمز عبور جدید</label>
                <div class="relative">
                    <input 
                        type="password" 
                        id="new_password" 
                        name="new_password"
                        v-model="newPassword" 
                        class="w-full pr-10 pl-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-200"
                    >
                </div>
                <p class="text-xs text-gray-500 mt-1">حداقل 8 کاراکتر</p>
            </div>
            
            <div>
                <label for="confirm_password" class="block text-sm font-medium text-gray-700 mb-1">تکرار رمز عبور جدید</label>
                <div class="relative">
                    <input 
                        type="password" 
                        id="confirm_password" 
                        name="confirm_password"
                        v-model="confirmPassword" 
                        class="w-full pr-10 pl-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-200"
                    >
                </div>
            </div>
            
            <div class="pt-2">
                <button @click="changePassword()" class="bg-indigo-600 text-white py-2 px-6 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    تغییر رمز عبور
                </button>
            </div>
        </div>
    </div>
</div>
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script>
    function successAlert(messageText){
        Swal.fire({title: "عملیات موفق",
        text:messageText,
        icon: "success",
        confirmButtonText: 'تائید'});
    }
    function failAlert(messageText){
        Swal.fire({title: "خطا",
        html: messageText,
        icon: "error",
        confirmButtonText: 'تائید'});
    }
    
    const user = Vue.createApp({
        data(){
            return{
                userName : '',
                email: '',
                createdAt : '',
                updatedAt : '',
                src : '{{base_url()}}uploads/profile.avif',
                imageFile: null
            }
        },
        mounted() {
            this.getUser();
        },
        methods: {
            toPersianNumber(enNumber) {
                if (enNumber === null || enNumber === undefined) return '';

                const numStr = String(enNumber);

                const persianDigits = '۰۱۲۳۴۵۶۷۸۹';

                return numStr.replace(/\d/g, function(match) {
                  return persianDigits[parseInt(match)];
                });
            },
            getUser(){
                const vm = this;
                $.ajax({
                  url: '{{base_url()}}User/getUser',
                  method: 'GET',
                  dataType: 'json',
                  success: function(response) {
                    if (response.status === 'success') {
                      vm.userName = response.data.name;
                      vm.email = response.data.email;
                      vm.createdAt = response.data.created_at;
                      vm.updatedAt = response.data.updated_at;
                      profileImage = response.data.profile_image_url;
                      vm.src = profileImage == null ? '{{base_url()}}uploads/profile.avif' : profileImage;
                      console.log('success :', response.message);
                    } else {
                      console.error('Failed :', response.message);
                    }
                  }
                });
            },
            updateUser(){
                const vm = this;
                $.ajax({
                  url: "{{base_url('User/update_user')}}",
                  method: 'POST',
                  data: {
                    'name':vm.userName,
                    'email':vm.email
                  },
                  dataType: 'json',
                  success: function(response) {
                    if (response.status === 'success') {
                        console.log(response.message);
                        vm.getUser();
                        successAlert(response.message);
                    } else {
                        failAlert(response.message);
                    }
                  }
                });
            },
            onFileChange(event) {
                this.imageFile = event.target.files[0];
            },
            uploadImage() {
                const vm = this;
                const formData = new FormData();
                formData.append("profile_image", this.imageFile);

                $.ajax({
                  url: "{{base_url('User/uploadProfileImage')}}",
                  method: "POST",
                  data: formData,
                  processData: false,   // ❗️required for FormData
                  contentType: false,   // ❗️required for FormData
                  dataType: "json",
                  success: function(response) {
                    if (response.status === "success") {
                      console.log("Upload success:", response.data);
                      successAlert(response.message);
                      vm.getUser();
                    } else {
                      failAlert(response.message);
                    }
                  }
                });
            }
        }
    }).mount("#user-info");

    const changePass = Vue.createApp({
        data(){
            return{
                currentPassword : '',
                newPassword : '',
                confirmPassword : ''
            }
        },
        methods: {
            changePassword(){
                const vm = this;
                $.ajax({
                          url: "{{base_url('User/change_password')}}",
                          method: 'POST',
                          data: {
                            'current_password' : vm.currentPassword,
                            'new_password' : vm.newPassword,
                            'confirm_password' : vm.confirmPassword
                          },
                          dataType: 'json',
                          success: function(response) {
                            if (response.status === 'success') {
                                vm.currentPassword = '';
                                vm.newPassword = '';
                                vm.confirmPassword = '';
                                successAlert(response.message);
                            } else {
                                failAlert(response.message);
                            }
                          }
                        });
            }
        }
    }).mount("#change-password");
</script>
{% endblock %}